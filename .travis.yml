jobs:
  include:
  - stage: Pre-built Test
    language: node_js
    node_js:
    - node
    cache:
      directories:
      - node_modules
  - stage: Test
    script:
    - echo "Testing"
    - docker build -t $DOCKER_USERNAME/express-boilerplate-test --build-arg "SOURCE_COMMIT=$(git rev-parse HEAD)" -f Dockerfile.test .
    - docker run --rm $DOCKER_USERNAME/express-boilerplate-test
  - stage: Build and Publish
    script:
    - echo "Building"
    - export LAST_COMMIT_SHA="${LAST_COMMIT_SHA:-$(git rev-parse HEAD)}"
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker build -t $DOCKER_USERNAME/express-boilerplate --build-arg "SOURCE_COMMIT=$(git rev-parse HEAD)" .
    - docker images
    - echo "Publishing to docker registry"
    - docker tag  $DOCKER_USERNAME/express-boilerplate $DOCKER_USERNAME/express-boilerplate
    - docker push $DOCKER_USERNAME/express-boilerplate
env:
  global:
  - secure: KmjqHcPBFB7D7iE76+jKkSSMdFwl3yPFMEekyQI0FCeUmL10V1X5jnku2R/lqJeoN3Fp9PmIMMZiJgquHEnnBA71Rij6ocRCO96mAmOwICdWAih3Uy+rPkgNQycGY1A4bBOCLtRltCRYyUuSUds8Uylzuf+q520yrpbtOJg8m5RHXMZ3hg7/orkv3pt9rNla5HrWQD+qo61+d5ja9YCqDTS29VPjKob2uOCWzEFfVdYMZ0c7Esq6f3R0D5QilGPuRD2Vv4zY95wuBtKjDiJkPBhKR3OuW0g2nSb3oqgNAwAjB2lFxt2QTllFjlmV7b9DVjoPI41PP+xOOgVIhBOTWHZo2/59UnYWMHLnRxFaaw4/Usik6uSVxp4ynGNcWZvGDT3aVyCaYgtHGgqsbsD2VDFmP9hKWuA6cT2AB9Jgv1e+FSOjS+EasULOPqfE+hf2krk1el8ELfruoiL/ldqdOBxfuJYnNmk4LLDPy8XAXS7fzOO8zh/4CGS4BX0JUZi2TlcT7EGjzd/f4MKhuFneU1NLyekQrKt50Wz9yl7SsXXx3SMix4EZ66Y13V7Ig5d9JjXi4FhnSYGXDZ8lNU0eQfrwW20ILQf2XJ8kF0hLMGtb7DrlL+zVC5OipFzfx/CRgWOnjRnOhscxjqeROXl+rLaCv/83SlUaxpYxmGhS+W8=
  - secure: eY3ttBYFRUnho9x158K9fkh/XFXiDrkFZrG5MVYNMIB6tIk0HWRIE6D2fSajQSRJlJ2Ggt1TQrHR1bgkaYrXAKN3u6ZOsBxJTOU3T73SBGyySpMxf75ra5AKhksKXqGMlEUobZwi6Ah28r2s7qMR0ebCiEgmQk8AJ/b/d+toqf2S+lkqHLRdwlwzGxsz1ebtTNgfhdUbvmpvIOh3zkuO/MYylzb6WYsX+esPt1akXN8lyJoCkzcAqsJS675mrIwUv4tIvKmZ7aixTYpZBWh0bPX7Fd/CZ11jqzU8mIwa3BmQC5Fw3UQ02IVTI43gLhkDrGgG7vBJyGimn+krZq8uxuaLz5B6wfc3i5oPVgMeehWIEK1drsMRq8t9wXQS0D/+/lSt2amPzvvDStHorQhvp/fbXY+GXS+uCKTDTMtl+Nniwy5u/gwaYhAFJH9nVUKWkgSe6KM/Vm5mkozULG8cx1KuaQ92aDId4SdvMj+o5tTVBsNKbdFbZgpCO/RoSrLrBAIhXahsAvGLWmCYYu7MsPOGCaT7TegnsXXZsCPkFPeL1vSObsB1PyQE3OrI+iEQuMRxIme5R6Z+9OXjFsegwjudoErCs76dSAPsIlIizpGrt4Wmd2650RMBcLb71RjEXgmR++gWhQUjiWw/CRZxirXXSZgT3f3LoUslEqEDrTk=
